<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>おんちゃ処 - 模擬店</title>
    
    <style>
        /* (CSSは変更ありません。省略) */
        .page{display:none;}.page.active{display:block;}
        #page-customer-top{background-color:#fff;}
        #page-customer-top body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans CJK JP","Yu Gothic",sans-serif;margin:0;padding:0;line-height:1.6;color:#333}
        #page-customer-top .container{width:90%;max-width:1000px;margin:0 auto;padding:0 20px}
        #page-customer-top header{background:#fdfdfd;border-bottom:1px solid #eee;padding:10px 0}
        #page-customer-top header .container{display:flex;justify-content:space-between;align-items:center}
        #page-customer-top .logo-img{height:50px;width:auto}
        #page-customer-top header nav ul{margin:0;padding:0;list-style:none}
        #page-customer-top header nav li{display:inline-block;margin-left:20px}
        #page-customer-top header nav a{text-decoration:none;color:#555;font-weight:700}
        #page-customer-top .hero{background:#e6f0e6;padding:60px 0;text-align:center}
        #page-customer-top .hero h2{font-size:36px;margin-bottom:10px;font-family:'Times New Roman',Times,serif}
        #page-customer-top .section{padding:40px 0;border-bottom:1px solid #f0f0f0}
        #page-customer-top .section h2{text-align:center;font-size:28px;margin-bottom:30px;color:#4a5c2f}
        #page-customer-top .section h3{font-size:24px;color:#333;border-bottom:2px solid #e6f0e6;padding-bottom:5px;margin-bottom:20px}
        #page-customer-top .menu-item{border:none;border-bottom:2px solid #e6f0e6;padding:15px 10px;background:#fff;display:flex;justify-content:space-between;align-items:baseline;flex-wrap:wrap}
        #page-customer-top .menu-item h4{font-size:1.2rem;font-weight:600;color:#4a5c2f;margin:0;flex-shrink:0}
        #page-customer-top .menu-item p{font-size:1.1rem;font-weight:700;color:#333;margin:0;white-space:nowrap;padding-left:10px}
        #page-customer-top .menu-item p.description{font-size:.9rem;font-weight:400;color:#555;flex-basis:100%;margin-top:5px;padding-left:0;white-space:normal}
        #page-customer-top #about,#page-customer-top #access{text-align:center}
        #page-customer-top footer{background:#333;color:#fff;text-align:center;padding:20px 0;margin-top:30px}
        #page-customer-top #credit-footer{cursor:pointer;user-select:none}
        #goto-order-button{display:block;width:80%;max-width:400px;margin:30px auto;padding:20px;font-size:1.5em;font-weight:700;color:#fff;background-color:#d9534f;border:none;border-radius:10px;cursor:pointer;text-align:center;text-decoration:none}
        #page-customer-order .menu-item{border-bottom:2px solid #e6f0e6;padding:15px 10px;background:#fff;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
        #page-customer-order .menu-item-details{flex:1 1 200px}
        #page-customer-order .menu-item-details h4{font-size:1.2rem;font-weight:600;color:#4a5c2f;margin:0}
        #page-customer-order .menu-item-details p.description{font-size:.9rem;font-weight:400;color:#555;margin-top:5px}
        #page-customer-order .menu-item-controls{display:flex;align-items:center;justify-content:flex-end;gap:15px;flex:1 1 180px;white-space:nowrap}
        #page-customer-order .menu-item-controls p{font-size:1.1rem;font-weight:700;color:#333;margin:0;min-width:50px;text-align:right}
        #page-customer-order #order-summary{background:#fff;border-top:2px solid #4a5c2f;padding:20px;position:sticky;bottom:0;box-shadow:0 -4px 10px rgba(0,0,0,.1);text-align:center}
        #page-customer-order #customer-total-price{font-size:1.8em;font-weight:700;color:#333;margin:10px 0}
        #page-customer-order #customer-confirm-button{background-color:#5cb85c;color:#fff;padding:15px 30px;font-size:1.2em;font-weight:700;border:none;border-radius:8px;cursor:pointer;width:100%;max-width:400px}
        #page-customer-order #cancel-customer-order-button{background-color:#aaa;margin-top:10px}
        #page-staff-confirm,#page-customer-receipt{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;text-align:center;padding:30px;max-width:600px;margin:40px auto;background:#fff;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
        #page-staff-confirm h2,#page-customer-receipt h2{font-size:1.5em;color:#4a5c2f;margin-top:0}
        .order-summary-list{text-align:left;list-style:none;padding:0;margin:20px 0;border-top:1px solid #eee;border-bottom:1px solid #eee}
        .order-summary-list li{padding:10px 5px;font-size:1.1em;border-bottom:1px dotted #ccc}
        .order-summary-list li:last-child{border-bottom:none}
        .order-summary-list span{float:right;font-weight:700}
        #staff-confirm-total,#receipt-total{font-size:1.8em;font-weight:700;color:#d9534f;margin:20px 0}
        #payment-received-button{background-color:#5cb85c;color:#fff;padding:15px 30px;font-size:1.2em;font-weight:700;border:none;border-radius:8px;cursor:pointer}
        #cancel-order-button{background-color:#f0ad4e;color:#fff;padding:15px 30px;font-size:1.2em;font-weight:700;border:none;border-radius:8px;cursor:pointer;margin-top:10px}
        #ticket-number{font-size:2.5em;font-weight:700;color:#d9534f;margin:20px 0}
        #pickup-button{background-color:#5bc0de;color:#fff;padding:15px 30px;font-size:1.2em;font-weight:700;border:none;border-radius:8px;cursor:pointer;margin-top:20px}
        div#page-staff-panel.container{text-align:left;max-width:600px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Hiragino Sans','Noto Sans CJK JP',sans-serif;background-color:#fff;padding:20px;line-height:1.6;color:#333;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.05);margin:20px auto}
        #page-staff-panel h1{text-align:center;color:#d9534f;border-bottom:2px solid #d9534f;margin-top:0;font-family:'Hiragino Sans',sans-serif}
        .staff-nav{display:flex;margin-bottom:20px}
        .nav-tab{flex:1;padding:12px 10px;font-size:1.1em;font-weight:700;text-align:center;border:1px solid #ccc;background-color:#f9f9f9;cursor:pointer}
        .nav-tab.active{background-color:#fff;border-bottom-color:#fff}
        #order-tab{border-radius:8px 0 0 8px;border-right:none}
        #log-tab{border-radius:0 8px 8px 0}
        .staff-page-content{display:none}.staff-page-content.active{display:block}
        #page-staff-order .order-item{display:flex;justify-content:space-between;align-items:center;padding:15px 10px;border-bottom:1px solid #eee;background:#fff}
        #page-staff-order .order-item .item-name{font-size:1.1em;font-weight:700;color:#333}
        #page-staff-order .count-controls{display:flex;align-items:center}
        #page-staff-order .count-controls button{width:40px;height:40px;font-size:1.5em;font-weight:700;border:1px solid #ccc;border-radius:50%;background-color:#f9f9f9;cursor:pointer;line-height:1}
        #page-staff-order .count-controls .count{font-size:1.4em;font-weight:700;width:50px;text-align:center}
        #page-staff-order #total-section{margin-top:30px;text-align:center}
        #page-staff-order #staff-total-price{font-size:2em;font-weight:700;color:#333;margin:15px 0}
        #page-staff-order .order-buttons{display:flex;justify-content:space-between;gap:10px;margin-top:20px}
        #page-staff-order .order-buttons button{flex:1;font-size:1.1em;padding:15px 10px;border:none;border-radius:5px;cursor:pointer;font-weight:700}
        #page-staff-order #staff-reset-button{background-color:#f0ad4e;color:#fff}
        #page-staff-order #staff-confirm-button{background-color:#5cb85c;color:#fff}
        #page-staff-log #log-container{max-height:400px;overflow-y:auto;border:1px solid #eee;border-radius:5px}
        #page-staff-log .log-entry{padding:15px;border-bottom:1px solid #ddd}
        #page-staff-log .log-entry:last-child{border-bottom:none}
        #page-staff-log .log-header{display:flex;justify-content:space-between;font-weight:700;margin-bottom:10px}
        #page-staff-log .log-ticket-time{display:flex;gap:10px;align-items:center;}
        #page-staff-log .log-ticket{font-size:1.1em;color:#d9534f;font-weight:700}
        #page-staff-log .log-time{font-size:.9em;color:#555}
        #page-staff-log .log-total{font-size:1.1em;color:#333}
        #page-staff-log .log-status{font-size:1em;font-weight:700}
        #page-staff-log .log-status.pending{color:#d9534f}
        #page-staff-log .log-status.completed{color:#5cb85c}
        #page-staff-log .log-items{list-style:none;margin-left:0;color:#444;margin-top:8px;padding:0}
        footer#staff-footer{background:#fff;color:#333;text-align:center;padding:20px 0;margin-top:30px}
        #back-to-customer{font-size:1em;padding:12px 20px;border:none;border-radius:5px;cursor:pointer;font-weight:700;background-color:#5bc0de;color:#fff}
        .count-controls{display:flex;align-items:center}
        .count-controls button{width:36px;height:36px;font-size:1.5em;font-weight:700;border:1px solid #ccc;border-radius:50%;background-color:#f9f9f9;cursor:pointer;line-height:1}
        .count-controls .count{font-size:1.2em;font-weight:700;width:40px;text-align:center}
    </style>
</head>
<body>

    <div id="page-customer-top" class="page active">
        <header>
            <div class="container">
                <a href="#"><img src="https://cdn.discordapp.com/attachments/1181206556193329204/1430417826119684106/IMG_0105.png?ex=68f9b3e9&is=68f86269&hm=a6b408007ee7fa235aeb9fc784f1297652815712fe13c2b3fdd986bcd87da7fb&" alt="おんちゃ処 ロゴ" class="logo-img"></a>
                <nav>
                    <ul>
                        <li><a href="#menu-static">お品書き</a></li>
                        <li><a href="#about">お店について</a></li>
                        <li><a href="#access">アクセス</a></li>
                        <li><a href="#receipt" id="goto-receipt-button" style="color:#d9534f;">整理券確認</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <section class="hero">
            <div class="container">
                <h2>A little luxury for your everyday</h2>
                <p>おんちゃ処へようこそ。</p>
                <a href="#order" id="goto-order-button">セルフオーダーはこちら</a>
            </div>
        </section>

        <section id="menu-static" class="container section">
            <h2>お品書き (MENU)</h2>
            <h3>Food</h3>
            <div class="menu-grid">
                <div class="menu-item"><h4>★ おんちゃセット</h4><p>¥500</p><p class="description">団子3種 + 100円ドリンク</p></div>
                <div class="menu-item"><h4>きな粉</h4><p>¥150</p></div>
                <div class="menu-item"><h4>みたらし</h4><p>¥150</p></div>
                <div class="menu-item"><h4>つぶあん</h4><p>¥150</p></div>
                <div class="menu-item"><h4>こしあん</h4><p>¥150</p></div>
                <div class="menu-item"><h4>のり醤油</h4><p>¥150</p></div>
                <div class="menu-item"><h4>あんこ増量</h4><p>¥20</p></div>
                <div class="menu-item"><h4>きな粉増量</h4><p>¥20</p></div>
            </div>
            <h3 style="margin-top: 40px;">Drink</h3>
            <div class="menu-grid">
                <div class="menu-item"><h4>緑茶</h4><p>¥100</p></div>
                <div class="menu-item"><h4>烏龍茶</h4><p>¥100</p></div>
                <div class="menu-item"><h4>水</h4><p>¥100</p></div>
                <div class="menu-item"><h4>コーラ</h4><p>¥100</p></div>
                <div class="menu-item"><h4>ソーダ</h4><p>¥100</p></div>
                <div class="menu-item"><h4>ジンジャーエール</h4><p>¥100</p></div>
                <div class="menu-item"><h4>ラムネ</h4><p>¥150</p></div>
            </div>
            <p style="text-align: center; margin-top: 20px;">* 価格はすべて税込です</p>
        </section>

        <section id="about" class="container section">
            <h2>お店について</h2>
            <p style="text-align: center;">私たち「おんちゃ処」は、毎日頑張るあなたに「ささやかな贅沢」をお届けします。<br>
                定番のみたらしやきな粉、こだわりののり醤油など、一つひとつ心を込めてご用意しました。<br>
                勉強や部活の合間に、美味しいお団子でほっと一息つきませんか。皆様のお越しをお待ちしております。</p>
        </section>

        <section id="access" class="container section">
            <h2>アクセス</h2>
            <p style="text-align: center;">皆様のお越しをお待ちしております！</p>
            <img src="https://media.discordapp.net/attachments/1181206556193329204/1430416379131072623/image.png?ex=68f9b290&is=68f86110&hm=1939ec9d2a5d8669054a44bfe5f295cc761fb5c7137d2ca4282f36e1805330ba&=&format=webp&quality=lossless&width=527&height=525" 
                 alt="お店の場所" style="width: 100%; max-width: 527px; display: block; margin: 0 auto; border-radius: 8px;">
        </section>

        <footer>
            <div class="container">
                <p id="credit-footer">&copy; 2025 おんちゃ処. All rights reserved.</p>
            </div>
        </footer>
    </div>
    
    <div id="page-customer-order" class="page">
        <section class="hero" style="padding: 30px 0;">
            <div class="container">
                <h2>ご注文</h2>
                <p>商品を選んで、下の「注文を確定する」ボタンを押してください。</p>
            </div>
        </section>
        
        <section class="container section">
            <h3>Food</h3>
            <div id="food-menu-grid"></div> 
            <h3 style="margin-top: 40px;">Drink</h3>
            <div id="drink-menu-grid"></div>
        </section>

        <div id="order-summary">
            <div id="customer-total-price">合計: ¥0</div>
            <button id="customer-confirm-button">注文を確定する</button>
            <button id="cancel-customer-order-button" class="order-buttons button">トップページに戻る</button>
        </div>
    </div>
    
    <div id="page-staff-confirm" class="page">
        <h2>ご注文内容の確認</h2>
        <p>お客様から以下の内容で注文を受け付けました。<br>内容と金額を確認し、代金をお受け取りください。</p>
        <ul id="confirm-summary" class="order-summary-list"></ul>
        <div id="staff-confirm-total">合計: ¥0</div>
        <button id="payment-received-button">料金受取完了</button>
        <button id="cancel-order-button">注文に戻る</button>
    </div>

    <div id="page-customer-receipt" class="page">
        <h2>ご注文ありがとうございます</h2>
        <h3 id="ticket-number">整理券番号Aです。</h3>
        <p>ご注文内容：</p>
        <ul id="receipt-summary" class="order-summary-list"></ul>
        <div id="receipt-total">合計: ¥0</div>
        <p>商品をご用意しますので、呼ばれるまでお待ちください。</p>
        <button id="pickup-button">（商品を受け取りました）</button>
    </div>
    
    
    <div id="page-staff-panel" class="page container">
        <header>
            <h1>【店員用】管理パネル</h1>
        </header>

        <nav class="staff-nav">
            <div id="order-tab" class="nav-tab active">手動オーダー</div>
            <div id="log-tab" class="nav-tab">LOG (履歴)</div>
        </nav>

        <div id="page-staff-order" class="staff-page-content active">
            <main id="staff-order-form"></main>
            <footer id="total-section">
                <div id="staff-total-price">合計: ¥0</div>
                <div class="order-buttons">
                    <button id="staff-reset-button">リセット</button>
                    <button id="staff-confirm-button">以上の内容で確定 (LOG記録)</button>
                </div>
            </footer>
        </div>

        <div id="page-staff-log" class="staff-page-content">
            <main id="log-container">
                <p style="text-align: center; color: #888;">ログを読み込み中です...</p>
            </main>
        </div>

        <footer id="staff-footer">
            <button id="back-to-customer">トップページに戻る</button>
        </footer>
    </div>


    <script>
        // ▼▼▼ ご指定のGASのURL（変更なし） ▼▼▼
        const GAS_WEB_APP_URL = 'https.script.google.com/macros/s/AKfycbxW0HjtF15pf0wQ_y9B6wfg-8O9CBwPR5TJ6sfod3APFKv_LPttI5LSRJWLry2nMXwK/exec';
        
        // --- 合言葉 ---
        const PASSWORDS = ['おんざはーる', 'オンザハール', 'オントッツォ', 'おんトッツォ'];
        
        // --- メニューデータ ---
        const menuItems = {
            'onset': { name: '★ おんちゃセット', price: 500, type: 'food', desc: '団子3種 + 100円ドリンク' },
            'kinako': { name: 'きな粉', price: 150, type: 'food' },
            'mitarashi': { name: 'みたらし', price: 150, type: 'food' },
            'tsubuan': { name: 'つぶあん', price: 150, type: 'food' },
            'koshian': { name: 'こしあん', price: 150, type: 'food' },
            'nori': { name: 'のり醤油', price: 150, type: 'food' },
            'anko_up': { name: 'あんこ増量', price: 20, type: 'food' },
            'kinako_up': { name: 'きな粉増量', price: 20, type: 'food' },
            'ryokucha': { name: '緑茶', price: 100, type: 'drink' },
            'oolong': { name: '烏龍茶', price: 100, type: 'drink' },
            'water': { name: '水', price: 100, type: 'drink' },
            'cola': { name: 'コーラ', price: 100, type: 'drink' },
            'soda': { name: 'ソーダ', price: 100, type: 'drink' },
            'ginger': { name: 'ジンジャーエール', price: 100, type: 'drink' },
            'ramune': { name: 'ラムネ', price: 150, type: 'drink' }
        };

        // 注文数を保持するオブジェクト
        let customerOrder = {};
        let staffOrder = {};

        // --- DOM要素の取得 (ページごと) ---
        const customerTopView = document.getElementById('page-customer-top');
        const creditFooter = document.getElementById('credit-footer');
        const gotoOrderButton = document.getElementById('goto-order-button');
        const gotoReceiptButton = document.getElementById('goto-receipt-button');

        const customerOrderView = document.getElementById('page-customer-order');
        const foodMenuGrid = document.getElementById('food-menu-grid');
        const drinkMenuGrid = document.getElementById('drink-menu-grid');
        const customerTotalPriceEl = document.getElementById('customer-total-price');
        const customerConfirmButton = document.getElementById('customer-confirm-button');
        const cancelCustomerOrderButton = document.getElementById('cancel-customer-order-button');
        
        const staffConfirmView = document.getElementById('page-staff-confirm');
        const confirmSummaryEl = document.getElementById('confirm-summary');
        const staffConfirmTotalEl = document.getElementById('staff-confirm-total');
        const paymentReceivedButton = document.getElementById('payment-received-button');
        const cancelOrderButton = document.getElementById('cancel-order-button');
        
        const customerReceiptView = document.getElementById('page-customer-receipt');
        const ticketNumberEl = document.getElementById('ticket-number');
        const receiptSummaryEl = document.getElementById('receipt-summary');
        const receiptTotalEl = document.getElementById('receipt-total');
        const pickupButton = document.getElementById('pickup-button');
        
        const staffPanelView = document.getElementById('page-staff-panel');
        const orderTab = document.getElementById('order-tab');
        const logTab = document.getElementById('log-tab');
        const staffOrderPage = document.getElementById('page-staff-order');
        const staffLogPage = document.getElementById('page-staff-log');
        const staffOrderForm = document.getElementById('staff-order-form');
        const staffTotalPriceEl = document.getElementById('staff-total-price');
        const staffResetButton = document.getElementById('staff-reset-button');
        const staffConfirmButton = document.getElementById('staff-confirm-button');
        const logContainer = document.getElementById('log-container');
        const backToCustomerButton = document.getElementById('back-to-customer');

        // --- ページ切り替え ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            window.scrollTo(0, 0); // ページトップにスクロール
        }

        // --- 共通: 注文サマリHTML生成 ---
        function generateOrderSummary(order) {
            let summaryHtml = '';
            for (const id in order) {
                if (order[id] > 0) {
                    summaryHtml += `<li>${menuItems[id].name} <span>x ${order[id]}</span></li>`;
                }
            }
            return summaryHtml;
        }

        // --- 共通: 注文合計計算 ---
        function calculateTotal(order) {
            let total = 0;
            for (const id in order) {
                const price = menuItems[id].price;
                total += order[id] * price;
            }
            return total;
        }

        // --- 共通: 時刻フォーマット ---
        function getTimestamp() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }
        

        // ==========================================
        // --- 顧客注文フロー (2. 顧客注文ページ) ---
        // ==========================================
        
        function initializeCustomerOrderForm() {
            foodMenuGrid.innerHTML = ''; 
            drinkMenuGrid.innerHTML = '';
            customerOrder = {}; 

            for (const id in menuItems) {
                customerOrder[id] = 0; 
                const item = menuItems[id];
                
                const el = document.createElement('div');
                el.className = 'menu-item';
                el.innerHTML = `
                    <div class="menu-item-details">
                        <h4>${item.name}</h4>
                        ${item.desc ? `<p class="description">${item.desc}</p>` : ''}
                    </div>
                    <div class="menu-item-controls">
                        <p>¥${item.price}</p>
                        <div class="count-controls">
                            <button onclick="updateCustomerOrder('${id}', -1)">-</button>
                            <span id="cust-count-${id}" class="count">0</span>
                            <button onclick="updateCustomerOrder('${id}', 1)">+</button>
                        </div>
                    </div>
                `;
                
                if (item.type === 'food') foodMenuGrid.appendChild(el);
                else drinkMenuGrid.appendChild(el);
            }
            updateCustomerTotal();
        }

        window.updateCustomerOrder = function(id, change) {
            const newCount = customerOrder[id] + change;
            if (newCount >= 0) { 
                customerOrder[id] = newCount;
                document.getElementById(`cust-count-${id}`).innerText = newCount;
                updateCustomerTotal();
            }
        }
        
        function updateCustomerTotal() {
            const total = calculateTotal(customerOrder);
            customerTotalPriceEl.innerText = `合計: ¥${total}`;
        }

        // ==========================================
        // --- 店員手動フロー (5. 店員パネル) ---
        // ==========================================
        
        function initializeStaffOrderForm() {
            staffOrderForm.innerHTML = ''; 
            staffOrder = {}; 

            for (const id in menuItems) {
                staffOrder[id] = 0; 
                const item = menuItems[id];
                const name = item.name;
                
                const el = document.createElement('div');
                el.className = 'order-item';
                el.innerHTML = `
                    <span class="item-name">${name}</span>
                    <div class="count-controls">
                        <button onclick="updateStaffOrder('${id}', -1)">-</button>
                        <span id="staff-count-${id}" class="count">0</span>
                        <button onclick="updateStaffOrder('${id}', 1)">+</button>
                    </div>
                `;
                staffOrderForm.appendChild(el);
            }
            updateStaffTotal();
        }

        window.updateStaffOrder = function(id, change) {
            const newCount = staffOrder[id] + change;
            if (newCount >= 0) { 
                staffOrder[id] = newCount;
                document.getElementById(`staff-count-${id}`).innerText = newCount;
                updateStaffTotal();
            }
        }
        
        function updateStaffTotal() {
            const total = calculateTotal(staffOrder);
            staffTotalPriceEl.innerText = `合計: ¥${total}`;
        }
        
        orderTab.addEventListener('click', () => {
            staffOrderPage.classList.add('active');
            staffLogPage.classList.remove('active');
            orderTab.classList.add('active');
            logTab.classList.remove('active');
        });
        logTab.addEventListener('click', () => {
            staffOrderPage.classList.remove('active');
            staffLogPage.classList.add('active');
            orderTab.classList.remove('active');
            logTab.classList.add('active');
            loadAndRenderLog(); 
        });


        // ==========================================
        // --- GAS (スプレッドシート連携) ---
        // ==========================================

        async function loadAndRenderLog() {
            logContainer.innerHTML = '<p style="text-align: center; color: #888;">ログを読み込み中です...</p>';
            try {
                // ▼▼▼ [修正] fetchから `mode: 'no-cors'` を削除 ▼▼▼
                const response = await fetch(GAS_WEB_APP_URL);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                
                const logs = result.data;
                if (logs.length === 0) {
                    logContainer.innerHTML = '<p style="text-align: center; color: #888;">まだ確定された注文はありません。</p>';
                    return;
                }
                
                logContainer.innerHTML = ''; // クリア
                logs.forEach(log => {
                    const logEl = document.createElement('div');
                    logEl.className = 'log-entry';
                    const statusClass = log.status === '未' ? 'pending' : 'completed';
                    
                    logEl.innerHTML = `
                        <div class="log-header">
                            <div class="log-ticket-time">
                                <span class="log-ticket">[${log.ticket}]</span>
                                <span class="log-time">${log.timestamp}</span>
                            </div>
                            <span class="log-status ${statusClass}">${log.status}</span>
                            <span class="log-total">¥${log.total}</span>
                        </div>
                        <ul class="log-items">
                            <li>${log.itemsSummary.replace(/, /g, '</li><li>')}</li>
                        </ul>
                    `;
                    logContainer.appendChild(logEl);
                });
            } catch (error) {
                console.error('Error loading log:', error);
                logContainer.innerHTML = `<p style="text-align: center; color: red;">エラー: ${error.message} (GASのURL、デプロイ、シート名「LOG」を確認してください)</p>`;
            }
        }
        
        // --- (POST) 新規注文をLOG書き込み (action: 'create') ---
        async function logOrderToGAS(isCustomerOrder, total, order) {
            let itemsToLog = [];
            for (const id in order) {
                if (order[id] > 0) {
                    itemsToLog.push(`${menuItems[id].name} x ${order[id]}`);
                }
            }
            const itemsSummary = itemsToLog.join(', ');
            
            const dataToPost = {
                action: 'create',
                isCustomerOrder: isCustomerOrder, // true or false
                itemsSummary: itemsSummary,
                total: total
            };

            try {
                if (isCustomerOrder) paymentReceivedButton.disabled = true;
                else staffConfirmButton.disabled = true;

                // ▼▼▼ [修正] fetchから `mode: 'no-cors'` と `headers` を削除 ▼▼▼
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(dataToPost) 
                });
                
                if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                
                const result = await response.json(); // GASからの戻り値(ticket, timestamp)を受け取る
                if (result.status !== 'success') throw new Error(result.message);
                
                return result; // {status: 'success', ticket: 'A', timestamp: '19:30:05'} を返す

            } catch (error) {
                console.error('Error posting log (create):', error);
                alert(`ログの書き込みに失敗しました: ${error.message}`);
                return null; // 失敗
            } finally {
                if (isCustomerOrder) paymentReceivedButton.disabled = false;
                else staffConfirmButton.disabled = false;
            }
        }
        
        // --- (POST) ステータス更新 (action: 'update') ---
        async function updateOrderStatus(ticketId, timestamp) {
            const dataToPost = {
                action: 'update',
                ticket: ticketId,
                timestamp: timestamp
            };
            
            try {
                // ▼▼▼ [修正] fetchから `mode: 'no-cors'` と `headers` を削除 ▼▼▼
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(dataToPost) 
                });
                if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                
                await response.json(); // 成功したか確認（中身は使わない）

            } catch (error) {
                console.error('Error posting log (update):', error);
                // ここでのエラーは顧客に通知しない
            }
        }

        // ==========================================
        // --- イベントリスナー設定 ---
        // ==========================================
        
        // --- 顧客トップページ ---
        gotoOrderButton.addEventListener('click', (e) => {
            e.preventDefault();
            initializeCustomerOrderForm(); 
            showPage('page-customer-order');
        });
        
        gotoReceiptButton.addEventListener('click', (e) => {
            e.preventDefault();
            const ticketId = customerReceiptView.dataset.ticketId;
            if (ticketId) {
                showPage('page-customer-receipt');
            } else {
                alert('この端末ではまだ注文が行われていません。\n「セルフオーダーはこちら」からご注文ください。');
            }
        });
        
        // --- 顧客注文ページ ---
        customerConfirmButton.addEventListener('click', () => {
            const total = calculateTotal(customerOrder);
            if (total === 0) {
                alert('商品が選択されていません。');
                return;
            }
            const summaryHtml = generateOrderSummary(customerOrder);
            confirmSummaryEl.innerHTML = summaryHtml;
            staffConfirmTotalEl.innerText = `合計: ¥${total}`;
            showPage('page-staff-confirm');
        });
        cancelCustomerOrderButton.addEventListener('click', () => {
            showPage('page-customer-top');
        });

        // --- 店員確認ページ ---
        cancelOrderButton.addEventListener('click', () => {
            showPage('page-customer-order');
        });

        // ▼▼▼ [修正] GASからの戻り値(result)を使うように変更 ▼▼▼
        paymentReceivedButton.addEventListener('click', async () => {
            const userInput = prompt('【合言葉】\nおんちゃの有名なコラ画像は？');
            if (userInput === null) return; 

            if (PASSWORDS.includes(userInput)) {
                // 認証成功
                const total = calculateTotal(customerOrder);
                
                // GASに送信 (isCustomerOrder: true)
                // GAS側が整理券番号(ticket)と時刻(timestamp)を決定する
                const result = await logOrderToGAS(true, total, customerOrder);
                
                if (result && result.status === 'success') {
                    // GASから返された ticket と timestamp を使用
                    const ticketId = result.ticket;
                    const timestamp = result.timestamp;
                    
                    // 整理券ページに内容をセット
                    ticketNumberEl.innerText = `整理券番号${ticketId}です。`;
                    receiptSummaryEl.innerHTML = generateOrderSummary(customerOrder);
                    receiptTotalEl.innerText = `合計: ¥${total}`;
                    
                    // 整理券ページにIDと時刻を保存 (Updateで使うため)
                    customerReceiptView.dataset.ticketId = ticketId;
                    customerReceiptView.dataset.timestamp = timestamp;
                    
                    showPage('page-customer-receipt');
                    initializeCustomerOrderForm();
                }
                
            } else {
                alert('お前さんは誰や');
            }
        });
        
        // --- 整理券ページ ---
        pickupButton.addEventListener('click', () => {
            const ticketId = customerReceiptView.dataset.ticketId;
            const timestamp = customerReceiptView.dataset.timestamp;
            if (ticketId && timestamp) {
                // (裏側で)ステータスを「済」に更新
                updateOrderStatus(ticketId, timestamp);
            }
            // この端末の整理券情報をクリア
            customerReceiptView.dataset.ticketId = "";
            customerReceiptView.dataset.timestamp = "";
            
            showPage('page-customer-top');
        });


        // --- 店員パネル (秘密の操作) ---
        let clickCount = 0;
        creditFooter.addEventListener('click', () => {
            clickCount++;
            if (clickCount >= 5) {
                const userInput = prompt('【合言葉】\nおんちゃの有名なコラ画像は？');
                clickCount = 0; 
                
                if (PASSWORDS.includes(userInput)) {
                    initializeStaffOrderForm(); 
                    showPage('page-staff-panel');
                    staffOrderPage.classList.add('active');
                    staffLogPage.classList.remove('active');
                    orderTab.classList.add('active');
                    logTab.classList.remove('active');
                } else if (userInput !== null) {
                    alert('お前さんは誰や');
                }
            }
            setTimeout(() => { clickCount = 0; }, 3000);
        });
        
        // --- 店員パネル (手動オーダー) ---
        staffResetButton.addEventListener('click', () => {
            if (confirm('現在のオーダーをリセットしますか？')) {
                initializeStaffOrderForm();
            }
        });
        
        staffConfirmButton.addEventListener('click', async () => {
            const total = calculateTotal(staffOrder);
            if (total === 0) {
                alert('商品が選択されていません。');
                return;
            }
            if (!confirm(`合計 ¥${total} で確定し、LOGに記録しますか？\n(この注文は「手動」として「受取済」で即時記録されます)`)) {
                return;
            }
            
            // GASに送信 (isCustomerOrder: false)
            const result = await logOrderToGAS(false, total, staffOrder);
            
            if (result && result.status === 'success') {
                alert('ログに記録しました。');
                initializeStaffOrderForm(); // フォームリセット
            }
        });
        
        // --- 店員パネル (戻るボタン) ---
        backToCustomerButton.addEventListener('click', () => {
            showPage('page-customer-top');
        });

        // --- 初期化実行 ---
        showPage('page-customer-top'); // 最初に表示するページ

    </script>
</body>
</html>