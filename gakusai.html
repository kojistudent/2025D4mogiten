<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>おんちゃ処 - 模擬店</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* === Tokichi.jp 風デザイン + 修正 === */
        body { background-color: #faf8f5; color: #333; font-family: 'Noto Sans JP', 'Hiragino Sans', sans-serif; letter-spacing: 0.03em; line-height: 1.8; margin: 0; padding: 0; }
        body::before { content: ""; position: fixed; inset: 0; background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png'); opacity: 0.08; pointer-events: none; z-index: -1; }
        h1, h2, h3, h4 { font-family: 'Shippori Mincho', serif; color: #2f3b23; }
        button, .btn, a.btn, input[type=button], input[type=submit] { background-color: #4a5c2f !important; color: #fff !important; border: none !important; border-radius: 6px; padding: 10px 20px; font-weight: 500; transition: background 0.3s ease, transform 0.2s ease; cursor: pointer; text-decoration: none; display: inline-block; text-align: center; }
        button:hover, .btn:hover, a.btn:hover, input[type=button]:hover, input[type=submit]:hover { background-color: #2f3b23 !important; transform: translateY(-2px); }
        #back-to-customer { background-color: #5bc0de !important; }
        #back-to-customer:hover { background-color: #31b0d5 !important; }
        .card, .menu-item, .order-item, .box, #page-customer-top .container, #page-staff-panel { background: #fff; border: 1px solid #e8e8e8; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.04); transition: box-shadow 0.3s ease, transform 0.3s ease; margin-bottom: 20px; }
        .menu-item:hover, #page-staff-order .order-item:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.08); }
        .container { width: 90%; max-width: 1000px; margin: 0 auto; padding: 30px 20px; }
        #page-staff-panel { padding: 20px; max-width: 600px; margin: 20px auto; }
        .section-title { font-family: 'Shippori Mincho', serif; font-size: 1.8em; color: #2f3b23; text-align: center; margin: 40px 0 30px; position: relative; }
        .section-title::after { content: ""; display: block; width: 60px; height: 2px; background: #a79e8f; margin: 10px auto 0; }
        .section h2 { font-family: 'Shippori Mincho', serif; font-size: 1.8em; color: #2f3b23; text-align: center; margin: 40px 0 30px; position: relative; }
        .section h2::after { content: ""; display: block; width: 60px; height: 2px; background: #a79e8f; margin: 10px auto 0; }
        .fade-in { opacity: 0; transform: translateY(30px); transition: opacity 0.8s ease, transform 0.8s ease; }
        .fade-in.visible { opacity: 1; transform: translateY(0); }
        header { background-color: #ffffff; border-bottom: 1px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.05); padding: 10px 0; }
        footer { background-color: #2f3b23; color: #fff; text-align: center; padding: 40px 20px; font-size: 0.9em; margin-top: 60px; border-top: 1px solid #ddd; }
        section { padding: 60px 0px; margin-bottom: 30px; }
        .page{display:none;}.page.active{display:block;}
        #page-customer-top .container{width:90%;max-width:1000px;margin: 0 auto; padding: 0 20px;}
        #page-customer-top header .container{display:flex;justify-content:space-between;align-items:center; background: none; border: none; box-shadow: none; margin-bottom: 0;}
        #page-customer-top .logo-img{height:50px;width:auto; cursor: pointer;} /* Added cursor pointer for BGM */
        #page-customer-top header nav ul{margin:0;padding:0;list-style:none}
        #page-customer-top header nav li{display:inline-block;margin-left:20px}
        #page-customer-top header nav a{text-decoration:none;color:#555;font-weight:700}
        #page-customer-top .hero h2{font-size:2.2em;margin-bottom:10px;font-family:'Shippori Mincho',serif}
        #page-customer-top .section h3{font-size:1.5em;color:#2f3b23;border-bottom:1px solid #eee;padding-bottom:10px;margin-bottom:25px}
        #page-customer-top .menu-item{border:none; border-bottom:1px solid #eee; padding:20px 10px; background:#fff;display:flex;justify-content:space-between;align-items:baseline;flex-wrap:wrap; margin-bottom: 10px;}
        #page-customer-top .menu-item h4{font-size:1.1rem;font-weight:700;color:#2f3b23;margin:0;flex-shrink:0}
        #page-customer-top .menu-item p{font-size:1.1rem;font-weight:500;color:#333;margin:0;white-space:nowrap;padding-left:10px}
        #page-customer-top .menu-item p.description{font-size:.9rem;font-weight:400;color:#555;flex-basis:100%;margin-top:5px;padding-left:0;white-space:normal}
        #page-customer-top #about p, #page-customer-top #location p { font-size: 1.1em; max-width: 600px; margin-left: auto; margin-right: auto;} /* IDをaccessからlocationに変更 */
        #page-customer-top footer p#credit-footer{cursor:pointer;user-select:none; color: #ccc;} /* Visible on dark footer */
        
        div#page-staff-panel.container{text-align:left;max-width:600px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Hiragino Sans','Noto Sans CJK JP',sans-serif;background-color:#fff;padding:20px;line-height:1.6;color:#333;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.05);margin:20px auto}
        #page-staff-panel h1{text-align:center;color:#d9534f;border-bottom:2px solid #d9534f;margin-top:0;font-family:'Hiragino Sans',sans-serif}
        .staff-nav{display:flex;margin-bottom:20px}
        .nav-tab{flex:1;padding:12px 10px;font-size:1.1em;font-weight:700;text-align:center;border:1px solid #ccc;background-color:#f9f9f9;cursor:pointer; transition: background 0.2s;}
        .nav-tab:hover { background-color: #eee; }
        .nav-tab.active{background-color:#fff;border-bottom-color:#fff}
        #order-tab{border-radius:8px 0 0 8px;border-right:none}
        #log-tab{border-radius:0 8px 8px 0}
        .staff-page-content{display:none}.staff-page-content.active{display:block}
        #page-staff-order .order-item{display:flex;justify-content:space-between;align-items:center;padding:15px 10px;border-bottom:1px solid #eee;background:#fff}
        #page-staff-order .order-item .item-name{font-size:1.1em;font-weight:700;color:#333}
        #page-staff-order #total-section{margin-top:30px;text-align:center}
        #page-staff-order #staff-total-price{font-size:1.8em;font-weight:700;color:#2f3b23;margin:15px 0}
        /* ▼▼▼ [修正] order-buttons のスタイルを調整して合計金額表示スペースを作る ▼▼▼ */
        #page-staff-order .order-buttons{display:flex;justify-content:space-between; align-items: center; /* 中央揃え */ gap:10px;margin-top:20px}
        /* ▲▲▲ 修正完了 ▲▲▲ */
        /* ▼▼▼ [追加] ボタン横の合計金額表示用スタイル ▼▼▼ */
        #staff-confirm-total-display {
            font-size: 1.1em;
            font-weight: 700;
            color: #d9534f; /* 赤色で目立たせる */
            flex-grow: 1; /* 空きスペースを埋める */
            text-align: center; /* 中央揃え */
        }
        /* ▲▲▲ 追加完了 ▲▲▲ */
        #page-staff-log #log-container{max-height:400px;overflow-y:auto;border:1px solid #eee;border-radius:5px; background: #fdfdfd;}
        #page-staff-log .log-entry{padding:15px;border-bottom:1px solid #ddd}
        #page-staff-log .log-entry:last-child{border-bottom:none}
        #page-staff-log .log-header{display:flex;justify-content:space-between;font-weight:700;margin-bottom:10px; align-items: center;}
        #page-staff-log .log-ticket-time{display:flex;gap:10px;align-items:center;}
        #page-staff-log .log-ticket{font-size:1.1em;color:#d9534f;font-weight:700}
        #page-staff-log .log-time{font-size:.9em;color:#555}
        #page-staff-log .log-total{font-size:1.1em;color:#333}
        #page-staff-log .log-status{font-size:1em;font-weight:700; padding: 2px 6px; border-radius: 4px; color: #fff;}
        #page-staff-log .log-status.pending{background-color:#d9534f}
        #page-staff-log .log-status.completed{background-color:#5cb85c}
        #page-staff-log .log-items{list-style:none;margin-left:0;color:#444;margin-top:8px;padding:0}
        footer#staff-footer{background:#fff;color:#333;text-align:center;padding:20px 0;margin-top:30px; border-top: 1px solid #ddd;}
        .count-controls{display:flex;align-items:center}
        .count-controls button{width:36px;height:36px;font-size:1.5em;font-weight:700;border:1px solid #ccc;border-radius:50%;background-color:#f9f9f9;cursor:pointer;line-height:1; transition: background 0.2s;}
        .count-controls button:hover { background-color: #eee; }
        .count-controls .count{font-size:1.2em;font-weight:700;width:40px;text-align:center}
        
        .staff-item-subtotal {
            font-size: 0.9em;
            color: #888;
            margin-left: 10px; /* カウントコントロールとの間に余白 */
            min-width: 60px; /* 幅を確保してガタつきを防ぐ */
            text-align: right;
            display: inline-block; /* 幅指定のため */
        }

        /* --- ここから画像を使った新しいスタイル --- */
        #page-customer-top .hero {
            position: relative;
            padding: 100px 0; /* 高さを確保 */
            color: #fff; /* テキストを白に */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.6); /* テキストの視認性向上 */
            background: #4a5c2f; /* JSが読み込まれるまでの仮の背景色 */
            background-size: cover;
            border-radius: 8px; /* 角を丸く */
            margin: 20px auto; /* 中央寄せと余白 */
            text-align: center;
            overflow: hidden; /* 角丸を適用するため */
        }

        #page-customer-top .hero::before { /* 薄いテクスチャを追加 */
            content: "";
            position: absolute;
            inset: 0;
            background-image: url('https://www.transparenttextures.com/patterns/fabric-of-squares.png'); /* 別のテクスチャを試す */
            opacity: 0.1;
            z-index: 1;
        }

        #page-customer-top .hero .container {
            position: relative;
            z-index: 2; /* テキストを画像の上に */
        }
        
        #page-customer-top .hero h2 {
            font-size: 3em; /* より大きく */
            color: #d7ffb8; /* ヒーローの文字色を明るい抹茶色に変更 */
            margin-bottom: 20px;
            font-family: 'Shippori Mincho', serif;
            letter-spacing: 0.08em;
        }
        #page-customer-top .hero p {
            font-size: 1.2em;
            color: #d7ffb8; /* ヒーローの文字色を明るい抹茶色に変更 */
            max-width: 700px;
            margin: 0 auto;
        }

        /* お品書きセクションのスタイルを「::before オーバーレイ」方式に統一 */
        #menu-static {
            /* background-image はJSで設定 */
            background-size: cover;
            background-position: center center;
            padding: 50px 20px;
            margin-top: 40px;
            position: relative; /* 重ね合わせのため */
            overflow: hidden; /* 角丸を適用するため */
        }

        #menu-static::before { /* テキストが読みやすいようにオーバーレイ */
            content: "";
            position: absolute;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.85); /* 白の半透明オーバーレイ (少し濃く) */
            z-index: 0;
        }

        #menu-static .section-title,
        #menu-static h3,
        #menu-static .menu-grid, /* .menu-itemの親もz-indexを適用 */
        #menu-static .dango-illustration, /* 団子画像もz-indexを適用 */
        #menu-static p {
            position: relative; /* オーバーレイより手前に */
            z-index: 1;
        }

        /* 団子の画像を挿入 */
        .dango-illustration {
            width: 80%; /* 幅を調整 */
            max-width: 400px; /* 最大幅 */
            display: block;
            margin: 30px auto; /* 中央寄せ */
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.1)); /* ぼんやりとした影 */
            opacity: 0.9; /* 少し透明度 */
        }

        /* 店舗についてのセクションに、より落ち着いた背景を追加 */
        #about {
            background-color: #f7f3ed; /* 少し温かみのある白 */
            border-left: 5px solid #a79e8f; /* アクセントライン */
            padding: 40px 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }
        #about p {
            color: #555;
            font-size: 1.05em;
            line-height: 2;
        }

        /* 出店場所セクションの画像をより目立たせる */
        #location img {
            border: 5px solid #fff; /* 白い枠線 */
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); /* 強めの影 */
            transition: transform 0.3s ease;
        }
        #location img:hover {
            transform: scale(1.02); /* ホバーで少し拡大 */
        }

    </style>
</head>
<body>

    <audio id="bgm" src="dango.mp3" loop></audio>

    <div id="page-customer-top" class="page active">
        <header>
            <div class="container">
                <a href="#"><img id="logo-image-trigger" src="ontyalog.png" alt="おんちゃ処 ロゴ" class="logo-img"></a>
                <nav>
                    <ul>
                        <li><a href="#menu-static">お品書き</a></li>
                        <li><a href="#about">お店について</a></li>
                        <li><a href="#location">出店場所</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <section class="hero fade-in">
            <div class="container">
                <h2>A little luxury for your everyday</h2>
                <p>おんちゃ処へようこそ。毎日頑張るあなたに「ささやかな贅沢」をお届けします。</p>
            </div>
        </section>

        <section id="menu-static" class="container section fade-in card"> <h2 class="section-title">お品書き (MENU)</h2>
            <div class="menu-grid">
                <h3>Food</h3>
                <div class="menu-item"><h4>★ おんちゃセット</h4><p>¥500</p><p class="description">団子3種 + 100円ドリンク</p></div>
                <div class="menu-item"><h4>きな粉</h4><p>¥150</p></div>
                <div class="menu-item"><h4>みたらし</h4><p>¥150</p></div>
                <div class="menu-item"><h4>つぶあん</h4><p>¥150</p></div>
                <div class="menu-item"><h4>こしあん</h4><p>¥150</p></div>
                <div class="menu-item"><h4>のり醤油</h4><p>¥150</p></div>
                <div class="menu-item"><h4>あんこ増量</h4><p>¥20</p></div>
                <div class="menu-item"><h4>きな粉増量</h4><p>¥20</p></div>
            </div>
            
            <img src="dango.jpg" alt="焼かれる団子" class="dango-illustration fade-in"> 
            
            <div class="menu-grid">
                <h3 style="margin-top: 40px;">Drink</h3>
                <div class="menu-item"><h4>緑茶</h4><p>¥100</p></div>
                <div class="menu-item"><h4>烏龍茶</h4><p>¥100</p></div>
                <div class="menu-item"><h4>水</h4><p>¥100</p></div>
                <div class="menu-item"><h4>コーラ</h4><p>¥100</p></div>
                <div class="menu-item"><h4>ソーダ</h4><p>¥100</p></div>
                <div class="menu-item"><h4>ジンジャーエール</h4><p>¥100</p></div>
                <div class="menu-item"><h4>ラムネ</h4><p>¥150</p></div>
            </div>
            <p style="text-align: center; margin-top: 20px;">* 価格はすべて税込です</p>
        </section>

        <section id="about" class="container section fade-in card"> <h2 class="section-title">お店について</h2>
            <p>私たち「おんちゃ処」は、毎日頑張るあなたに「ささやかな贅沢」をお届けします。<br>
                定番のみたらしやきな粉、こだわりののり醤油など、一つひとつ心を込めてご用意しました。<br>
                勉強や部活の合間に、美味しいお団子でほっと一息つきませんか。皆様のお越しをお待ちしております。</p>
        </section>

        <section id="location" class="container section fade-in card"> 
            <h2 class="section-title">出店場所</h2>
            <p>皆様のお越しをお待ちしております！</p>
            <img src="basyo.png" 
                 alt="出店場所" style="width: 100%; max-width: 527px; display: block; margin: 20px auto; border-radius: 8px;">
        </section>

        <footer>
            <div class="container">
                <p id="credit-footer">&copy; 2025 おんちゃ処. All rights reserved.</p>
            </div>
        </footer>
    </div>
    
    
    <div id="page-staff-panel" class="page container card"> 
        <header>
            <h1>【店員用】管理パネル</h1>
        </header>

        <nav class="staff-nav">
            <div id="order-tab" class="nav-tab active">手動オーダー</div>
            <div id="log-tab" class="nav-tab">LOG (履歴)</div>
        </nav>

        <div id="page-staff-order" class="staff-page-content active">
            <h3 id="staff-order-header" style="text-align: center; color: #d9534f; margin-top: 0; font-family: 'Noto Sans JP', sans-serif;"></h3>
            
            <main id="staff-order-form"></main>
            <footer id="total-section">
                <div id="staff-total-price">合計: ¥0</div>
                <div class="order-buttons">
                    <button id="staff-reset-button">リセット</button>
                    <span id="staff-confirm-total-display">合計: ¥0</span> <button id="staff-confirm-button">以上の内容で確定 (LOG記録)</button>
                </div>
                </footer>
        </div>

        <div id="page-staff-log" class="staff-page-content">
            <main id="log-container">
                <p style="text-align: center; color: #888;">ログを読み込み中です...</p>
            </main>
        </div>

        <footer id="staff-footer">
            <button id="back-to-customer">トップページに戻る</button>
        </footer>
    </div>


    <script>
        // ▼▼▼ ご指定のGASのURL（変更なし） ▼▼▼
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyh_xBtC7ZSfYuKJZuoKv8BsTJWpvTqC3vAhjoZ7qYvH3p9r8JFTqCi3092ktNJP3am/exec'; // ここを最新のURLに
        
        // --- 合言葉 ---
        const PASSWORDS = ['おんざはーる', 'オンザハール', 'オントッツォ', 'おんトッツォ'];
        
        // --- メニューデータ ---
        const menuItems = {
            'onset': { name: '★ おんちゃセット', price: 500, type: 'food', desc: '団子3種 + 100円ドリンク' },
            'kinako': { name: 'きな粉', price: 150, type: 'food' },
            'mitarashi': { name: 'みたらし', price: 150, type: 'food' },
            'tsubuan': { name: 'つぶあん', price: 150, type: 'food' },
            'koshian': { name: 'こしあん', price: 150, type: 'food' },
            'nori': { name: 'のり醤油', price: 150, type: 'food' },
            'anko_up': { name: 'あんこ増量', price: 20, type: 'food' },
            'kinako_up': { name: 'きな粉増量', price: 20, type: 'food' },
            'ryokucha': { name: '緑茶', price: 100, type: 'drink' },
            'oolong': { name: '烏龍茶', price: 100, type: 'drink' },
            'water': { name: '水', price: 100, type: 'drink' },
            'cola': { name: 'コーラ', price: 100, type: 'drink' },
            'soda': { name: 'ソーダ', price: 100, type: 'drink' },
            'ginger': { name: 'ジンジャーエール', price: 100, type: 'drink' },
            'ramune': { name: 'ラムネ', price: 150, type: 'drink' }
        };

        // 注文数を保持するオブジェクト
        let staffOrder = {};
        
        // 次の整理券番号を保持する変数
        let currentNextTicket = 1; 

        // --- DOM要素の取得 (ページごと) ---
        const customerTopView = document.getElementById('page-customer-top');
        const creditFooter = document.getElementById('credit-footer');
        const logoImageTrigger = document.getElementById('logo-image-trigger');
        
        const staffPanelView = document.getElementById('page-staff-panel');
        const orderTab = document.getElementById('order-tab');
        const logTab = document.getElementById('log-tab');
        const staffOrderPage = document.getElementById('page-staff-order');
        const staffLogPage = document.getElementById('page-staff-log');
        const staffOrderForm = document.getElementById('staff-order-form');
        const staffTotalPriceEl = document.getElementById('staff-total-price');
        const staffResetButton = document.getElementById('staff-reset-button');
        const staffConfirmButton = document.getElementById('staff-confirm-button');
        const logContainer = document.getElementById('log-container');
        const backToCustomerButton = document.getElementById('back-to-customer');
        const staffOrderHeaderEl = document.getElementById('staff-order-header');
        
        // ▼▼▼ [追加] ボタン横の合計金額表示用DOM要素 ▼▼▼
        const staffConfirmTotalDisplayEl = document.getElementById('staff-confirm-total-display');
        // ▲▲▲ 追加完了 ▲▲▲

        // --- ページ切り替え ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            window.scrollTo(0, 0); // ページトップにスクロール
        }

        // --- 共通: 注文合計計算 ---
        function calculateTotal(order) {
            let total = 0;
            for (const id in order) {
                if(menuItems[id]) {
                    const price = menuItems[id].price;
                    total += order[id] * price;
                } else {
                    console.warn(`Menu item with id "${id}" not found.`);
                }
            }
            return total;
        }
        
        // 手動オーダーのヘッダー更新関数
        function updateStaffOrderHeader() {
            if (staffOrderHeaderEl) {
                staffOrderHeaderEl.innerText = `これは ${currentNextTicket} 人目のお客さんのオーダーです`;
            }
        }
        
        // ==========================================
        // --- 店員手動フロー (5. 店員パネル) ---
        // ==========================================
        
        function initializeStaffOrderForm() {
            staffOrderForm.innerHTML = ''; 
            staffOrder = {}; 

            for (const id in menuItems) {
                staffOrder[id] = 0; 
                const item = menuItems[id];
                const name = item.name;
                
                const el = document.createElement('div');
                el.className = 'order-item'; 
                
                el.innerHTML = `
                    <span class="item-name">${name}</span>
                    <div style="display: flex; align-items: center;"> 
                        <div class="count-controls">
                            <button onclick="updateStaffOrder('${id}', -1)">-</button>
                            <span id="staff-count-${id}" class="count">0</span>
                            <button onclick="updateStaffOrder('${id}', 1)">+</button>
                        </div>
                        <span id="staff-subtotal-${id}" class="staff-item-subtotal">¥0</span> 
                    </div>
                `;
                staffOrderForm.appendChild(el);
            }
            updateStaffTotal();
            updateStaffOrderHeader();
        }

        window.updateStaffOrder = function(id, change) {
            const newCount = (staffOrder[id] || 0) + change; 
            if (newCount >= 0 && menuItems[id]) { 
                staffOrder[id] = newCount;
                document.getElementById(`staff-count-${id}`).innerText = newCount;
                
                const subtotal = newCount * menuItems[id].price;
                const subtotalEl = document.getElementById(`staff-subtotal-${id}`);
                if (subtotalEl) {
                    subtotalEl.innerText = `¥${subtotal}`;
                }
                
                updateStaffTotal();
            }
        }
        
        // ▼▼▼ [修正] updateStaffTotal でボタン横の合計も更新 ▼▼▼
        function updateStaffTotal() {
            const total = calculateTotal(staffOrder);
            staffTotalPriceEl.innerText = `合計: ¥${total}`;
            // ボタン横の合計金額表示も更新
            if (staffConfirmTotalDisplayEl) {
                staffConfirmTotalDisplayEl.innerText = `合計: ¥${total}`;
            }
        }
        // ▲▲▲ 修正完了 ▲▲▲
        
        orderTab.addEventListener('click', () => {
            staffOrderPage.classList.add('active');
            staffLogPage.classList.remove('active');
            orderTab.classList.add('active');
            logTab.classList.remove('active');
        });
        logTab.addEventListener('click', () => {
            staffOrderPage.classList.remove('active');
            staffLogPage.classList.add('active');
            orderTab.classList.remove('active');
            logTab.classList.add('active');
            loadAndRenderLog(); 
        });


        // ==========================================
        // --- GAS (スプレッドシート連携) ---
        // ==========================================

        async function fetchNextTicketAndUpdateHeader() {
            try {
                const response = await fetch(GAS_WEB_APP_URL);
                if (!response.ok) throw new Error('Network error fetching next ticket');
                
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                
                currentNextTicket = result.nextTicket; 
                updateStaffOrderHeader(); 
                
            } catch (error) {
                console.error('Error fetching next ticket:', error);
                if (staffOrderHeaderEl) {
                    staffOrderHeaderEl.innerText = 'オーダー番号の取得に失敗';
                }
            }
        }

        async function loadAndRenderLog() {
            logContainer.innerHTML = '<p style="text-align: center; color: #888;">ログを読み込み中です...</p>';
            try {
                const response = await fetch(GAS_WEB_APP_URL);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                
                currentNextTicket = result.nextTicket; // LOGタブを開いたときも次の番号を同期
                
                const logs = result.data;
                if (logs.length === 0) {
                    logContainer.innerHTML = '<p style="text-align: center; color: #888;">まだ確定された注文はありません。</p>';
                    return;
                }
                
                logContainer.innerHTML = ''; // クリア
                logs.forEach(log => {
                    const logEl = document.createElement('div');
                    logEl.className = 'log-entry';
                    const statusClass = log.status === '未' ? 'pending' : 'completed';
                    
                    logEl.innerHTML = `
                        <div class="log-header">
                            <div class="log-ticket-time">
                                <span class="log-ticket">[${log.ticket}]</span>
                                <span class="log-time">${log.timestamp}</span>
                            </div>
                            <span class="log-status ${statusClass}">${log.status}</span>
                            <span class="log-total">¥${log.total}</span>
                        </div>
                        <ul class="log-items">
                            <li>${log.itemsSummary.replace(/, /g, '</li><li>')}</li>
                        </ul>
                    `;
                    logContainer.appendChild(logEl);
                });
            } catch (error) {
                console.error('Error loading log:', error);
                logContainer.innerHTML = `<p style="text-align: center; color: red;">エラー: ${error.message} (GASのURL、デプロイ、シート名「LOG」を確認してください)</p>`;
            }
        }
        
        async function logOrderToGAS(total, order) {
            let itemsToLog = [];
            for (const id in order) {
                if (order[id] > 0 && menuItems[id]) { 
                    itemsToLog.push(`${menuItems[id].name} x ${order[id]}`);
                }
            }
            const itemsSummary = itemsToLog.join(', ');
            
            const dataToPost = {
                action: 'create',
                isCustomerOrder: false, 
                itemsSummary: itemsSummary,
                total: total
            };

            try {
                staffConfirmButton.disabled = true; 

                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(dataToPost) 
                });
                
                if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                
                const result = await response.json(); 
                if (result.status !== 'success') throw new Error(result.message);
                
                return result; 

            } catch (error) {
                console.error('Error posting log (create):', error);
                alert(`ログの書き込みに失敗しました: ${error.message}`);
                return null; 
            } finally {
                staffConfirmButton.disabled = false; 
            }
        }
        
        // ==========================================
        // --- イベントリスナー設定 ---
        // ==========================================
        
        let clickCount = 0;
        creditFooter.addEventListener('click', async () => {
            clickCount++;
            if (clickCount >= 3) { 
                const userInput = prompt('【合言葉】\nおんちゃの有名なコラ画像は？');
                clickCount = 0; 
                
                if (PASSWORDS.includes(userInput)) {
                    await fetchNextTicketAndUpdateHeader(); 
                    initializeStaffOrderForm(); 
                    showPage('page-staff-panel');
                    staffOrderPage.classList.add('active');
                    staffLogPage.classList.remove('active');
                    orderTab.classList.add('active');
                    logTab.classList.remove('active');
                } else if (userInput !== null) {
                    alert('お前さんは誰や');
                }
            }
            setTimeout(() => { clickCount = 0; }, 2000); 
        });
        
        staffResetButton.addEventListener('click', () => {
            if (confirm('現在のオーダーをリセットしますか？')) {
                initializeStaffOrderForm(); 
            }
        });
        
        staffConfirmButton.addEventListener('click', async () => {
            const total = calculateTotal(staffOrder);
            if (total === 0) {
                alert('商品が選択されていません。');
                return;
            }
            if (!confirm(`合計 ¥${total} で確定し、LOGに記録しますか？\n(整理券番号 ${currentNextTicket} として記録されます)`)) {
                return;
            }
            
            const result = await logOrderToGAS(total, staffOrder);
            
            if (result && result.status === 'success') {
                alert(`ログに記録しました (整理券番号: ${result.ticket})`);
                currentNextTicket++; 
                initializeStaffOrderForm(); 
            }
        });
        
        backToCustomerButton.addEventListener('click', () => {
            showPage('page-customer-top');
        });

        document.addEventListener('DOMContentLoaded', () => {
            const logoTrigger = document.getElementById('logo-image-trigger');
            if (logoTrigger) { 
                logoTrigger.addEventListener('click', () => {
                    const bgm = document.getElementById('bgm');
                    if (bgm && bgm.paused) { 
                        bgm.play().catch(e => console.error("BGMの再生に失敗しました:", e)); 
                    }
                }, { once: true }); 
            } else {
                console.error("Logo image trigger not found!"); 
            }

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target); 
                    }
                });
            }, { threshold: 0.1 }); 

            document.querySelectorAll('.fade-in').forEach(el => {
                observer.observe(el);
            });

            function tryLoadImage(src) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(src);
                    img.onerror = () => reject(src);
                    img.src = src;
                });
            }
            async function firstAvailable(sources) {
                for (const s of sources) {
                    try { await tryLoadImage(s); return s; } catch (e) { /* 続行 */ }
                }
                return null;
            }

            (async () => {
                const hero = document.querySelector('.hero');
                if (hero) {
                    const heroSrc = await firstAvailable(['haikei.jpg', 'image3.png','image3.jpg']);
                    if (heroSrc) {
                        hero.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('${heroSrc}')`;
                        hero.style.backgroundSize = 'cover';
                    } else {
                        console.warn('hero background: 画像が見つかりません (haikei/image3)');
                    }
                }

                const menuStatic = document.getElementById('menu-static');
                if (menuStatic) {
                    const menuSrc = await firstAvailable(['gakkou.jpg', 'image1.png','image1.jpg']);
                    if (menuSrc) {
                        menuStatic.style.backgroundImage = `url('${menuSrc}')`;
                    } else {
                        console.warn('menu-static background: gakkou.jpg/image1.png/jpg が見つかりません');
                    }
                }

                const dango = document.querySelector('.dango-illustration');
                if (dango) {
                    const dangoSrc = await firstAvailable(['dango.jpg', 'image2.png','image2.jpg']);
                    if (dangoSrc) dango.src = dangoSrc;
                    else console.warn('dango illustration: dango.jpg/image2.png/jpg が見つかりません');
                }

                const locationImg = document.querySelector('#location img');
                if (locationImg) {
                    const locSrc = await firstAvailable(['basyo.png', 'basyo.jpg']);
                    if (locSrc) locationImg.src = locSrc;
                    else console.warn('location image: basyo.png/jpg が見つかりません');
                }
            })();

        });

        // --- 初期化実行 ---
        showPage('page-customer-top'); // 最初に表示するページ

    </script>
</body>
</html>