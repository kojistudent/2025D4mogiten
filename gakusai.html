<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>おんちゃ処 - 模擬店</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* === Tokichi.jp 風デザイン + 修正 === */
        body { background-color: #faf8f5; color: #333; font-family: 'Noto Sans JP', 'Hiragino Sans', sans-serif; letter-spacing: 0.03em; line-height: 1.8; margin: 0; padding: 0; }
        body::before { content: ""; position: fixed; inset: 0; background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png'); opacity: 0.08; pointer-events: none; z-index: -1; }
        h1, h2, h3, h4 { font-family: 'Shippori Mincho', serif; color: #2f3b23; }
        button, .btn, a.btn, input[type=button], input[type=submit] { background-color: #4a5c2f !important; color: #fff !important; border: none !important; border-radius: 6px; padding: 10px 20px; font-weight: 500; transition: background 0.3s ease, transform 0.2s ease; cursor: pointer; text-decoration: none; display: inline-block; text-align: center; }
        button:hover, .btn:hover, a.btn:hover, input[type=button]:hover, input[type=submit]:hover { background-color: #2f3b23 !important; transform: translateY(-2px); }
        #goto-order-button { width: 80%; max-width: 400px; margin: 30px auto; padding: 20px; font-size: 1.5em;}
        #cancel-customer-order-button { background-color: #aaa !important; margin-top: 10px; width: 100%; max-width: 400px;}
        #cancel-customer-order-button:hover { background-color: #888 !important; }
        #checkout-complete-button { background-color: #5cb85c !important; } /* ボタン名は会計完了だがIDはそのまま */
        #checkout-complete-button:hover { background-color: #449d44 !important; }
        #cancel-order-button { background-color: #f0ad4e !important; }
        #cancel-order-button:hover { background-color: #ec971f !important; }
        #pickup-button { background-color: #5bc0de !important; }
        #pickup-button:hover { background-color: #31b0d5 !important; }
        #back-to-customer { background-color: #5bc0de !important; }
        #back-to-customer:hover { background-color: #31b0d5 !important; }
        .card, .menu-item, .order-item, .box, #page-customer-top .container, #page-customer-order .container, #page-staff-confirm, #page-customer-receipt, #page-staff-panel { background: #fff; border: 1px solid #e8e8e8; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.04); transition: box-shadow 0.3s ease, transform 0.3s ease; margin-bottom: 20px; }
        .menu-item:hover, #page-staff-order .order-item:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.08); }
        .container { width: 90%; max-width: 1000px; margin: 0 auto; padding: 30px 20px; }
        #page-staff-confirm, #page-customer-receipt { padding: 30px; max-width: 600px; margin: 40px auto; }
        #page-staff-panel { padding: 20px; max-width: 600px; margin: 20px auto; }
        .section-title { font-family: 'Shippori Mincho', serif; font-size: 1.8em; color: #2f3b23; text-align: center; margin: 40px 0 30px; position: relative; }
        .section-title::after { content: ""; display: block; width: 60px; height: 2px; background: #a79e8f; margin: 10px auto 0; }
        .section h2 { font-family: 'Shippori Mincho', serif; font-size: 1.8em; color: #2f3b23; text-align: center; margin: 40px 0 30px; position: relative; }
        .section h2::after { content: ""; display: block; width: 60px; height: 2px; background: #a79e8f; margin: 10px auto 0; }
        .fade-in { opacity: 0; transform: translateY(30px); transition: opacity 0.8s ease, transform 0.8s ease; }
        .fade-in.visible { opacity: 1; transform: translateY(0); }
        header { background-color: #ffffff; border-bottom: 1px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.05); padding: 10px 0; }
        footer { background-color: #2f3b23; color: #fff; text-align: center; padding: 40px 20px; font-size: 0.9em; margin-top: 60px; border-top: 1px solid #ddd; }
        section { padding: 60px 0px; margin-bottom: 30px; }
        .hero { padding: 60px 0; }
        .page{display:none;}.page.active{display:block;}
        #page-customer-top .container{width:90%;max-width:1000px;margin: 0 auto; padding: 0 20px;}
        #page-customer-top header .container{display:flex;justify-content:space-between;align-items:center; background: none; border: none; box-shadow: none; margin-bottom: 0;}
        #page-customer-top .logo-img{height:50px;width:auto; cursor: pointer;} /* Added cursor pointer for BGM */
        #page-customer-top header nav ul{margin:0;padding:0;list-style:none}
        #page-customer-top header nav li{display:inline-block;margin-left:20px}
        #page-customer-top header nav a{text-decoration:none;color:#555;font-weight:700}
        #page-customer-top .hero h2{font-size:2.2em;margin-bottom:10px;font-family:'Shippori Mincho',serif}
        #page-customer-top .section h3{font-size:1.5em;color:#2f3b23;border-bottom:1px solid #eee;padding-bottom:10px;margin-bottom:25px}
        #page-customer-top .menu-item{border:none; border-bottom:1px solid #eee; padding:20px 10px; background:#fff;display:flex;justify-content:space-between;align-items:baseline;flex-wrap:wrap; margin-bottom: 10px;}
        #page-customer-top .menu-item h4{font-size:1.1rem;font-weight:700;color:#2f3b23;margin:0;flex-shrink:0}
        #page-customer-top .menu-item p{font-size:1.1rem;font-weight:500;color:#333;margin:0;white-space:nowrap;padding-left:10px}
        #page-customer-top .menu-item p.description{font-size:.9rem;font-weight:400;color:#555;flex-basis:100%;margin-top:5px;padding-left:0;white-space:normal}
        #page-customer-top #about p, #page-customer-top #access p { font-size: 1.1em; max-width: 600px; margin-left: auto; margin-right: auto;}
        /* ▼▼▼ [修正] フッター文字色を修正 ▼▼▼ */
        #page-customer-top footer p#credit-footer{cursor:pointer;user-select:none; color: #ccc;} /* Visible on dark footer */
        /* ▲▲▲ 修正完了 ▲▲▲ */
        #page-customer-order .hero { padding: 30px 0; }
        #page-customer-order .section { padding: 40px 0px; }
        #page-customer-order .container { padding: 20px; background: none; border: none; box-shadow: none; margin-bottom: 0;} /* Reset card style */
        #page-customer-order h3 {font-size:1.5em;color:#2f3b23;border-bottom:1px solid #eee;padding-bottom:10px;margin-bottom:25px}
        #page-customer-order .menu-item{border-bottom:1px solid #eee;padding:20px 10px;background:#fff;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap; margin-bottom: 10px;}
        #page-customer-order .menu-item-details h4{font-size:1.1rem;font-weight:700;color:#2f3b23;margin:0}
        #page-customer-order .menu-item-details p.description{font-size:.9rem;font-weight:400;color:#555;margin-top:5px}
        #page-customer-order .menu-item-controls p{font-size:1.1rem;font-weight:500;color:#333;margin:0;min-width:50px;text-align:right}
        #page-customer-order #order-summary{background:#fff;border-top:1px solid #ddd;padding:20px;position:sticky;bottom:0;box-shadow:0 -2px 5px rgba(0,0,0,0.06);text-align:center}
        #page-customer-order #customer-total-price{font-size:1.6em;font-weight:700;color:#2f3b23;margin:10px 0}
        #page-staff-confirm h2,#page-customer-receipt h2{font-size:1.5em;color:#2f3b23;margin-top:0}
        .order-summary-list{text-align:left;list-style:none;padding: 15px 0;margin:20px 0;border-top:1px solid #eee;border-bottom:1px solid #eee}
        .order-summary-list li{padding:12px 5px;font-size:1.1em;border-bottom:1px dotted #ccc}
        .order-summary-list li:last-child{border-bottom:none}
        .order-summary-list span{float:right;font-weight:700}
        #staff-confirm-total{font-size:1.6em;font-weight:700;color:#d9534f;margin:25px 0; display: flex; align-items: center; justify-content: center;}
        #ticket-number{font-size:2em;font-weight:700;color:#d9534f;margin:25px 0}
        /* ▼▼▼ [修正] タップエリアのスタイル調整 ▼▼▼ */
         #staff-tap-area {
            display: inline-block;
            font-size: 1.2em; /* 少し小さく */
            color: #ddd; /* さらに薄く */
            cursor: pointer; user-select: none;
            padding: 2px 6px; /* パディング縮小 */
            margin-left: 8px; /* マージン縮小 */
            line-height: 1;
            border-radius: 3px; /* 少し丸める */
            /* border と background は削除 */
            transition: color 0.2s;
        }
         #staff-tap-area:hover { color: #aaa; } /* ホバー色変更 */
         /* ▲▲▲ 修正完了 ▲▲▲ */
        div#page-staff-panel.container{text-align:left;max-width:600px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Hiragino Sans','Noto Sans CJK JP',sans-serif;background-color:#fff;padding:20px;line-height:1.6;color:#333;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.05);margin:20px auto}
        #page-staff-panel h1{text-align:center;color:#d9534f;border-bottom:2px solid #d9534f;margin-top:0;font-family:'Hiragino Sans',sans-serif}
        .staff-nav{display:flex;margin-bottom:20px}
        .nav-tab{flex:1;padding:12px 10px;font-size:1.1em;font-weight:700;text-align:center;border:1px solid #ccc;background-color:#f9f9f9;cursor:pointer; transition: background 0.2s;}
        .nav-tab:hover { background-color: #eee; }
        .nav-tab.active{background-color:#fff;border-bottom-color:#fff}
        #order-tab{border-radius:8px 0 0 8px;border-right:none}
        #log-tab{border-radius:0 8px 8px 0}
        .staff-page-content{display:none}.staff-page-content.active{display:block}
        #page-staff-order .order-item{display:flex;justify-content:space-between;align-items:center;padding:15px 10px;border-bottom:1px solid #eee;background:#fff}
        #page-staff-order .order-item .item-name{font-size:1.1em;font-weight:700;color:#333}
        #page-staff-order #total-section{margin-top:30px;text-align:center}
        #page-staff-order #staff-total-price{font-size:1.8em;font-weight:700;color:#2f3b23;margin:15px 0}
        #page-staff-order .order-buttons{display:flex;justify-content:space-between;gap:10px;margin-top:20px}
        #page-staff-log #log-container{max-height:400px;overflow-y:auto;border:1px solid #eee;border-radius:5px; background: #fdfdfd;}
        #page-staff-log .log-entry{padding:15px;border-bottom:1px solid #ddd}
        #page-staff-log .log-entry:last-child{border-bottom:none}
        #page-staff-log .log-header{display:flex;justify-content:space-between;font-weight:700;margin-bottom:10px; align-items: center;}
        #page-staff-log .log-ticket-time{display:flex;gap:10px;align-items:center;}
        #page-staff-log .log-ticket{font-size:1.1em;color:#d9534f;font-weight:700}
        #page-staff-log .log-time{font-size:.9em;color:#555}
        #page-staff-log .log-total{font-size:1.1em;color:#333}
        #page-staff-log .log-status{font-size:1em;font-weight:700; padding: 2px 6px; border-radius: 4px; color: #fff;}
        #page-staff-log .log-status.pending{background-color:#d9534f}
        #page-staff-log .log-status.completed{background-color:#5cb85c}
        #page-staff-log .log-items{list-style:none;margin-left:0;color:#444;margin-top:8px;padding:0}
        footer#staff-footer{background:#fff;color:#333;text-align:center;padding:20px 0;margin-top:30px; border-top: 1px solid #ddd;}
        .count-controls{display:flex;align-items:center}
        .count-controls button{width:36px;height:36px;font-size:1.5em;font-weight:700;border:1px solid #ccc;border-radius:50%;background-color:#f9f9f9;cursor:pointer;line-height:1; transition: background 0.2s;}
        .count-controls button:hover { background-color: #eee; }
        .count-controls .count{font-size:1.2em;font-weight:700;width:40px;text-align:center}

    </style>
</head>
<body>

    <audio id="bgm" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_9cfa08a8f7.mp3?filename=japanese-instrumental-ambient-11213.mp3" loop></audio>

    <div id="page-customer-top" class="page active">
        <header>
            <div class="container">
                <a href="#"><img id="logo-image-trigger" src="https://cdn.discordapp.com/attachments/1181206556193329204/1430417826119684106/IMG_0105.png?ex=68f9b3e9&is=68f86269&hm=a6b408007ee7fa235aeb9fc784f1297652815712fe13c2b3fdd986bcd87da7fb&" alt="おんちゃ処 ロゴ" class="logo-img"></a>
                <nav>
                    <ul>
                        <li><a href="#menu-static">お品書き</a></li>
                        <li><a href="#about">お店について</a></li>
                        <li><a href="#access">アクセス</a></li>
                        <li><a href="#receipt" id="goto-receipt-button" style="color:#d9534f;">整理券確認</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <section class="hero fade-in">
            <div class="container">
                <h2>A little luxury for your everyday</h2>
                <p>おんちゃ処へようこそ。</p>
                <a href="#order" id="goto-order-button" class="btn">セルフオーダーはこちら</a>
            </div>
        </section>

        <section id="menu-static" class="container section fade-in card"> <h2 class="section-title">お品書き (MENU)</h2>
            <h3>Food</h3>
            <div class="menu-grid">
                <div class="menu-item"><h4>★ おんちゃセット</h4><p>¥500</p><p class="description">団子3種 + 100円ドリンク</p></div>
                <div class="menu-item"><h4>きな粉</h4><p>¥150</p></div>
                <div class="menu-item"><h4>みたらし</h4><p>¥150</p></div>
                <div class="menu-item"><h4>つぶあん</h4><p>¥150</p></div>
                <div class="menu-item"><h4>こしあん</h4><p>¥150</p></div>
                <div class="menu-item"><h4>のり醤油</h4><p>¥150</p></div>
                <div class="menu-item"><h4>あんこ増量</h4><p>¥20</p></div>
                <div class="menu-item"><h4>きな粉増量</h4><p>¥20</p></div>
            </div>
            <h3 style="margin-top: 40px;">Drink</h3>
            <div class="menu-grid">
                <div class="menu-item"><h4>緑茶</h4><p>¥100</p></div>
                <div class="menu-item"><h4>烏龍茶</h4><p>¥100</p></div>
                <div class="menu-item"><h4>水</h4><p>¥100</p></div>
                <div class="menu-item"><h4>コーラ</h4><p>¥100</p></div>
                <div class="menu-item"><h4>ソーダ</h4><p>¥100</p></div>
                <div class="menu-item"><h4>ジンジャーエール</h4><p>¥100</p></div>
                <div class="menu-item"><h4>ラムネ</h4><p>¥150</p></div>
            </div>
            <p style="text-align: center; margin-top: 20px;">* 価格はすべて税込です</p>
        </section>

        <section id="about" class="container section fade-in card"> <h2 class="section-title">お店について</h2>
            <p>私たち「おんちゃ処」は、毎日頑張るあなたに「ささやかな贅沢」をお届けします。<br>
                定番のみたらしやきな粉、こだわりののり醤油など、一つひとつ心を込めてご用意しました。<br>
                勉強や部活の合間に、美味しいお団子でほっと一息つきませんか。皆様のお越しをお待ちしております。</p>
        </section>

        <section id="access" class="container section fade-in card"> <h2 class="section-title">アクセス</h2>
            <p>皆様のお越しをお待ちしております！</p>
            <img src="https://media.discordapp.net/attachments/1181206556193329204/1430416379131072623/image.png?ex=68f9b290&is=68f86110&hm=1939ec9d2a5d8669054a44bfe5f295cc761fb5c7137d2ca4282f36e1805330ba&=&format=webp&quality=lossless&width=527&height=525" 
                 alt="お店の場所" style="width: 100%; max-width: 527px; display: block; margin: 20px auto; border-radius: 8px;">
        </section>

        <footer>
            <div class="container">
                <p id="credit-footer">&copy; 2025 おんちゃ処. All rights reserved.</p>
            </div>
        </footer>
    </div>
    
    <div id="page-customer-order" class="page">
        <section class="hero" style="padding: 30px 0;">
            <div class="container card"> <h2 class="section-title" style="margin-top: 0;">ご注文</h2>
                <p>商品を選んで、下の「注文を確定する」ボタンを押してください。</p>
            </div>
        </section>
        
        <section class="container section card" style="padding-top: 0;"> <h3>Food</h3>
            <div id="food-menu-grid"></div> 
            <h3 style="margin-top: 40px;">Drink</h3>
            <div id="drink-menu-grid"></div>
        </section>

        <div id="order-summary">
            <div id="customer-total-price">合計: ¥0</div>
            <button id="customer-confirm-button">注文を確定する</button>
            <button id="cancel-customer-order-button">トップページに戻る</button> 
        </div>
    </div>
    
    <div id="page-staff-confirm" class="page card"> 
        <h2 class="section-title">ご注文内容の確認</h2>
        <p>お客様から以下の内容で注文を受け付けました。<br>内容と金額を確認し、代金をお受け取りください。</p>
        <ul id="confirm-summary" class="order-summary-list"></ul>
        
        <div id="staff-confirm-total">合計: ¥0 <span id="staff-tap-area">•</span></div>
        
        <button id="checkout-complete-button">会計完了</button>
        <button id="cancel-order-button">注文に戻る</button>
    </div>

    <div id="page-customer-receipt" class="page card"> 
        <h2 class="section-title">ご注文ありがとうございます</h2>
        <h3 id="ticket-number">整理券番号Aです。</h3>
        <p>ご注文内容：</p>
        <ul id="receipt-summary" class="order-summary-list"></ul>
        <div id="receipt-total">合計: ¥0</div>
        <p>商品をご用意しますので、呼ばれるまでお待ちください。</p>
        <button id="pickup-button">（商品を受け取りました）</button>
    </div>
    
    
    <div id="page-staff-panel" class="page container card"> 
        <header>
            <h1>【店員用】管理パネル</h1>
        </header>

        <nav class="staff-nav">
            <div id="order-tab" class="nav-tab active">手動オーダー</div>
            <div id="log-tab" class="nav-tab">LOG (履歴)</div>
        </nav>

        <div id="page-staff-order" class="staff-page-content active">
            <main id="staff-order-form"></main>
            <footer id="total-section">
                <div id="staff-total-price">合計: ¥0</div>
                <div class="order-buttons">
                    <button id="staff-reset-button">リセット</button>
                    <button id="staff-confirm-button">以上の内容で確定 (LOG記録)</button>
                </div>
            </footer>
        </div>

        <div id="page-staff-log" class="staff-page-content">
            <main id="log-container">
                <p style="text-align: center; color: #888;">ログを読み込み中です...</p>
            </main>
        </div>

        <footer id="staff-footer">
            <button id="back-to-customer">トップページに戻る</button>
        </footer>
    </div>


    <script>
        // ▼▼▼ ご指定のGASのURL（変更なし） ▼▼▼
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxA5sTsfPocp97uQKfgEIX3f96JF024jC4G8DTKyiL5CWPeVBHKrJOuBFcEf2vZowkf/exec'; // ここを最新のURLに
        
        // --- 合言葉 ---
        const PASSWORDS = ['おんざはーる', 'オンザハール', 'オントッツォ', 'おんトッツォ'];
        
        // --- メニューデータ ---
        const menuItems = {
            'onset': { name: '★ おんちゃセット', price: 500, type: 'food', desc: '団子3種 + 100円ドリンク' },
            'kinako': { name: 'きな粉', price: 150, type: 'food' },
            'mitarashi': { name: 'みたらし', price: 150, type: 'food' },
            'tsubuan': { name: 'つぶあん', price: 150, type: 'food' },
            'koshian': { name: 'こしあん', price: 150, type: 'food' },
            'nori': { name: 'のり醤油', price: 150, type: 'food' },
            'anko_up': { name: 'あんこ増量', price: 20, type: 'food' },
            'kinako_up': { name: 'きな粉増量', price: 20, type: 'food' },
            'ryokucha': { name: '緑茶', price: 100, type: 'drink' },
            'oolong': { name: '烏龍茶', price: 100, type: 'drink' },
            'water': { name: '水', price: 100, type: 'drink' },
            'cola': { name: 'コーラ', price: 100, type: 'drink' },
            'soda': { name: 'ソーダ', price: 100, type: 'drink' },
            'ginger': { name: 'ジンジャーエール', price: 100, type: 'drink' },
            'ramune': { name: 'ラムネ', price: 150, type: 'drink' }
        };

        // 注文数を保持するオブジェクト
        let customerOrder = {};
        let staffOrder = {};

        // --- DOM要素の取得 (ページごと) ---
        const customerTopView = document.getElementById('page-customer-top');
        const creditFooter = document.getElementById('credit-footer');
        const gotoOrderButton = document.getElementById('goto-order-button');
        const gotoReceiptButton = document.getElementById('goto-receipt-button');
        // ▼▼▼ [追加] BGM再生用ロゴID ▼▼▼
        const logoImageTrigger = document.getElementById('logo-image-trigger');

        const customerOrderView = document.getElementById('page-customer-order');
        const foodMenuGrid = document.getElementById('food-menu-grid');
        const drinkMenuGrid = document.getElementById('drink-menu-grid');
        const customerTotalPriceEl = document.getElementById('customer-total-price');
        const customerConfirmButton = document.getElementById('customer-confirm-button');
        const cancelCustomerOrderButton = document.getElementById('cancel-customer-order-button');
        
        const staffConfirmView = document.getElementById('page-staff-confirm');
        const confirmSummaryEl = document.getElementById('confirm-summary');
        const staffConfirmTotalEl = document.getElementById('staff-confirm-total');
        const checkoutCompleteButton = document.getElementById('checkout-complete-button');
        const staffTapArea = document.getElementById('staff-tap-area');
        const cancelOrderButton = document.getElementById('cancel-order-button');
        
        const customerReceiptView = document.getElementById('page-customer-receipt');
        const ticketNumberEl = document.getElementById('ticket-number');
        const receiptSummaryEl = document.getElementById('receipt-summary');
        const receiptTotalEl = document.getElementById('receipt-total');
        const pickupButton = document.getElementById('pickup-button');
        
        const staffPanelView = document.getElementById('page-staff-panel');
        const orderTab = document.getElementById('order-tab');
        const logTab = document.getElementById('log-tab');
        const staffOrderPage = document.getElementById('page-staff-order');
        const staffLogPage = document.getElementById('page-staff-log');
        const staffOrderForm = document.getElementById('staff-order-form');
        const staffTotalPriceEl = document.getElementById('staff-total-price');
        const staffResetButton = document.getElementById('staff-reset-button');
        const staffConfirmButton = document.getElementById('staff-confirm-button');
        const logContainer = document.getElementById('log-container');
        const backToCustomerButton = document.getElementById('back-to-customer');

        // --- ページ切り替え ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            window.scrollTo(0, 0); // ページトップにスクロール
        }

        // --- 共通: 注文サマリHTML生成 ---
        function generateOrderSummary(order) {
            let summaryHtml = '';
            for (const id in order) {
                if (order[id] > 0) {
                    summaryHtml += `<li>${menuItems[id].name} <span>x ${order[id]}</span></li>`;
                }
            }
            return summaryHtml;
        }

        // --- 共通: 注文合計計算 ---
        function calculateTotal(order) {
            let total = 0;
            for (const id in order) {
                const price = menuItems[id].price;
                total += order[id] * price;
            }
            return total;
        }
        
        // ==========================================
        // --- 顧客注文フロー (2. 顧客注文ページ) ---
        // ==========================================
        
        function initializeCustomerOrderForm() {
            foodMenuGrid.innerHTML = ''; 
            drinkMenuGrid.innerHTML = '';
            customerOrder = {}; 

            for (const id in menuItems) {
                customerOrder[id] = 0; 
                const item = menuItems[id];
                
                const el = document.createElement('div');
                el.className = 'menu-item card'; // Added card class
                el.innerHTML = `
                    <div class="menu-item-details">
                        <h4>${item.name}</h4>
                        ${item.desc ? `<p class="description">${item.desc}</p>` : ''}
                    </div>
                    <div class="menu-item-controls">
                        <p>¥${item.price}</p>
                        <div class="count-controls">
                            <button onclick="updateCustomerOrder('${id}', -1)">-</button>
                            <span id="cust-count-${id}" class="count">0</span>
                            <button onclick="updateCustomerOrder('${id}', 1)">+</button>
                        </div>
                    </div>
                `;
                
                if (item.type === 'food') foodMenuGrid.appendChild(el);
                else drinkMenuGrid.appendChild(el);
            }
            updateCustomerTotal();
        }

        window.updateCustomerOrder = function(id, change) {
            const newCount = customerOrder[id] + change;
            if (newCount >= 0) { 
                customerOrder[id] = newCount;
                document.getElementById(`cust-count-${id}`).innerText = newCount;
                updateCustomerTotal();
            }
        }
        
        function updateCustomerTotal() {
            const total = calculateTotal(customerOrder);
            customerTotalPriceEl.innerText = `合計: ¥${total}`;
        }

        // ==========================================
        // --- 店員手動フロー (5. 店員パネル) ---
        // ==========================================
        
        function initializeStaffOrderForm() {
            staffOrderForm.innerHTML = ''; 
            staffOrder = {}; 

            for (const id in menuItems) {
                staffOrder[id] = 0; 
                const item = menuItems[id];
                const name = item.name;
                
                const el = document.createElement('div');
                el.className = 'order-item'; // Keep specific class for staff order
                el.innerHTML = `
                    <span class="item-name">${name}</span>
                    <div class="count-controls">
                        <button onclick="updateStaffOrder('${id}', -1)">-</button>
                        <span id="staff-count-${id}" class="count">0</span>
                        <button onclick="updateStaffOrder('${id}', 1)">+</button>
                    </div>
                `;
                staffOrderForm.appendChild(el);
            }
            updateStaffTotal();
        }

        window.updateStaffOrder = function(id, change) {
            const newCount = staffOrder[id] + change;
            if (newCount >= 0) { 
                staffOrder[id] = newCount;
                document.getElementById(`staff-count-${id}`).innerText = newCount;
                updateStaffTotal();
            }
        }
        
        function updateStaffTotal() {
            const total = calculateTotal(staffOrder);
            staffTotalPriceEl.innerText = `合計: ¥${total}`;
        }
        
        orderTab.addEventListener('click', () => {
            staffOrderPage.classList.add('active');
            staffLogPage.classList.remove('active');
            orderTab.classList.add('active');
            logTab.classList.remove('active');
        });
        logTab.addEventListener('click', () => {
            staffOrderPage.classList.remove('active');
            staffLogPage.classList.add('active');
            orderTab.classList.remove('active');
            logTab.classList.add('active');
            loadAndRenderLog(); 
        });


        // ==========================================
        // --- GAS (スプレッドシート連携) ---
        // ==========================================

        async function loadAndRenderLog() {
            logContainer.innerHTML = '<p style="text-align: center; color: #888;">ログを読み込み中です...</p>';
            try {
                const response = await fetch(GAS_WEB_APP_URL);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                
                const logs = result.data;
                if (logs.length === 0) {
                    logContainer.innerHTML = '<p style="text-align: center; color: #888;">まだ確定された注文はありません。</p>';
                    return;
                }
                
                logContainer.innerHTML = ''; // クリア
                logs.forEach(log => {
                    const logEl = document.createElement('div');
                    logEl.className = 'log-entry';
                    const statusClass = log.status === '未' ? 'pending' : 'completed';
                    
                    logEl.innerHTML = `
                        <div class="log-header">
                            <div class="log-ticket-time">
                                <span class="log-ticket">[${log.ticket}]</span>
                                <span class="log-time">${log.timestamp}</span>
                            </div>
                            <span class="log-status ${statusClass}">${log.status}</span>
                            <span class="log-total">¥${log.total}</span>
                        </div>
                        <ul class="log-items">
                            <li>${log.itemsSummary.replace(/, /g, '</li><li>')}</li>
                        </ul>
                    `;
                    logContainer.appendChild(logEl);
                });
            } catch (error) {
                console.error('Error loading log:', error);
                logContainer.innerHTML = `<p style="text-align: center; color: red;">エラー: ${error.message} (GASのURL、デプロイ、シート名「LOG」を確認してください)</p>`;
            }
        }
        
        // --- (POST) 新規注文をLOG書き込み (action: 'create') ---
        async function logOrderToGAS(isCustomerOrder, total, order) {
            let itemsToLog = [];
            for (const id in order) {
                if (order[id] > 0) {
                    itemsToLog.push(`${menuItems[id].name} x ${order[id]}`);
                }
            }
            const itemsSummary = itemsToLog.join(', ');
            
            const dataToPost = {
                action: 'create',
                isCustomerOrder: isCustomerOrder, // true or false
                itemsSummary: itemsSummary,
                total: total
            };

            try {
                if (isCustomerOrder) checkoutCompleteButton.disabled = true; // ボタン無効化
                else staffConfirmButton.disabled = true;

                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(dataToPost) 
                });
                
                if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                
                const result = await response.json(); 
                if (result.status !== 'success') throw new Error(result.message);
                
                return result; // {status: 'success', ticket: 1, timestamp: '19:30:05'} を返す

            } catch (error) {
                console.error('Error posting log (create):', error);
                alert(`ログの書き込みに失敗しました: ${error.message}`);
                return null; // 失敗
            } finally {
                if (isCustomerOrder) checkoutCompleteButton.disabled = false; // ボタン有効化
                else staffConfirmButton.disabled = false;
            }
        }
        
        // --- (POST) ステータス更新 (action: 'update') ---
        async function updateOrderStatus(ticketId, timestamp) {
            const dataToPost = {
                action: 'update',
                ticket: ticketId,
                timestamp: timestamp
            };
            
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(dataToPost) 
                });
                if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                
                await response.json(); // 成功したか確認（中身は使わない）

            } catch (error) {
                console.error('Error posting log (update):', error);
                // ここでのエラーは顧客に通知しない
            }
        }

        // ==========================================
        // --- イベントリスナー設定 ---
        // ==========================================
        
        // --- 顧客トップページ ---
        gotoOrderButton.addEventListener('click', (e) => {
            e.preventDefault();
            initializeCustomerOrderForm(); 
            showPage('page-customer-order');
        });
        
        gotoReceiptButton.addEventListener('click', (e) => {
            e.preventDefault();
            const ticketId = customerReceiptView.dataset.ticketId;
            if (ticketId) {
                showPage('page-customer-receipt');
            } else {
                alert('この端末ではまだ注文が行われていません。\n「セルフオーダーはこちら」からご注文ください。');
            }
        });
        
        // --- 顧客注文ページ ---
        customerConfirmButton.addEventListener('click', () => {
            const total = calculateTotal(customerOrder);
            if (total === 0) {
                alert('商品が選択されていません。');
                return;
            }
            const summaryHtml = generateOrderSummary(customerOrder);
            confirmSummaryEl.innerHTML = summaryHtml;
            // ▼▼▼ staffConfirmTotalEl のテキストノードだけを更新 ▼▼▼
            staffConfirmTotalEl.firstChild.textContent = `合計: ¥${total} `; 
            showPage('page-staff-confirm');
        });
        cancelCustomerOrderButton.addEventListener('click', () => {
            showPage('page-customer-top');
        });

        // --- 店員確認ページ ---
        cancelOrderButton.addEventListener('click', () => {
            showPage('page-customer-order');
        });

        checkoutCompleteButton.addEventListener('click', () => {
             alert("合計金額の隣の • マークをタップしてください。"); // タップを促すアラート
        });
        
        staffTapArea.addEventListener('click', async () => {
            
            const total = calculateTotal(customerOrder);
            const result = await logOrderToGAS(true, total, customerOrder);
            
            if (result && result.status === 'success') {
                const ticketId = result.ticket; // 数値
                const timestamp = result.timestamp;
                
                ticketNumberEl.innerText = `整理券番号 ${ticketId} です。`; 
                receiptSummaryEl.innerHTML = generateOrderSummary(customerOrder);
                receiptTotalEl.innerText = `合計: ¥${total}`;
                
                customerReceiptView.dataset.ticketId = ticketId;
                customerReceiptView.dataset.timestamp = timestamp;
                
                showPage('page-customer-receipt');
                initializeCustomerOrderForm();
            }
        });
        
        // --- 整理券ページ ---
        pickupButton.addEventListener('click', () => {
            const ticketId = customerReceiptView.dataset.ticketId;
            const timestamp = customerReceiptView.dataset.timestamp;
            if (ticketId && timestamp) {
                updateOrderStatus(ticketId, timestamp);
            }
            customerReceiptView.dataset.ticketId = "";
            customerReceiptView.dataset.timestamp = "";
            
            showPage('page-customer-top');
        });


        // --- 店員パネル (秘密の操作) ---
        let clickCount = 0;
        creditFooter.addEventListener('click', () => {
            clickCount++;
             // ▼▼▼ [修正] 5回 -> 3回 ▼▼▼
            if (clickCount >= 3) { 
                const userInput = prompt('【合言葉】\nおんちゃの有名なコラ画像は？');
                clickCount = 0; 
                
                if (PASSWORDS.includes(userInput)) {
                    initializeStaffOrderForm(); 
                    showPage('page-staff-panel');
                    staffOrderPage.classList.add('active');
                    staffLogPage.classList.remove('active');
                    orderTab.classList.add('active');
                    logTab.classList.remove('active');
                } else if (userInput !== null) {
                    alert('お前さんは誰や');
                }
            }
            // ▼▼▼ [修正] 3秒 -> 2秒 ▼▼▼
            setTimeout(() => { clickCount = 0; }, 2000); 
        });
        
        // --- 店員パネル (手動オーダー) ---
        staffResetButton.addEventListener('click', () => {
            if (confirm('現在のオーダーをリセットしますか？')) {
                initializeStaffOrderForm();
            }
        });
        
        staffConfirmButton.addEventListener('click', async () => {
            const total = calculateTotal(staffOrder);
            if (total === 0) {
                alert('商品が選択されていません。');
                return;
            }
            if (!confirm(`合計 ¥${total} で確定し、LOGに記録しますか？\n(この注文は「手動」として「受取済」で即時記録されます)`)) {
                return;
            }
            
            const result = await logOrderToGAS(false, total, staffOrder);
            
            if (result && result.status === 'success') {
                alert('ログに記録しました。');
                initializeStaffOrderForm(); // フォームリセット
            }
        });
        
        // --- 店員パネル (戻るボタン) ---
        backToCustomerButton.addEventListener('click', () => {
            showPage('page-customer-top');
        });

        // --- BGM再生 & アニメーション ---
        document.addEventListener('DOMContentLoaded', () => {
            // ▼▼▼ [修正] BGM再生トリガーをロゴ画像に変更 ▼▼▼
            const logoTrigger = document.getElementById('logo-image-trigger');
            if (logoTrigger) { // 要素が存在するか確認
                logoTrigger.addEventListener('click', () => {
                    const bgm = document.getElementById('bgm');
                    if (bgm && bgm.paused) { 
                        bgm.play().catch(e => console.error("BGM Playback failed:", e)); 
                    }
                }, { once: true }); 
            } else {
                console.error("Logo image trigger not found!"); // デバッグ用
            }

            // フェードインアニメーション
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target); // 一度表示したら監視をやめる
                    }
                });
            }, { threshold: 0.1 }); // 10%見えたら表示開始

            document.querySelectorAll('.fade-in').forEach(el => {
                observer.observe(el);
            });
        });

        // --- 初期化実行 ---
        showPage('page-customer-top'); // 最初に表示するページ

    </script>
</body>
</html>